# Look for reference first, if we have it don't do anything
$text = (get-content (Resolve-Path "${PROJECT_DIR}/${PROJECT_NAME}.vcxproj"))
if ($text -like '*ANGLE.WindowsStore.2.1.13*') {
    exit
}

# Configure to add reference to ANGLE.WindowsStore

$xml = [xml](get-content (Resolve-Path "${PROJECT_DIR}/${PROJECT_NAME}.vcxproj"))

# Search for importgroup to see if it is there

$importGroup = $xml.CreateElement("ImportGroup", $xml.Project.xmlns)
$importGroup.SetAttribute("Label", "ExtensionTargets")

$importGroupImport = $xml.CreateElement("Import", $xml.Project.xmlns)
$importGroupImport.SetAttribute("Project", "..\packages\ANGLE.WindowsStore.2.1.13\build\native\ANGLE.WindowsStore.targets")
$importGroupImport.SetAttribute("Condition", "Exists('..\packages\ANGLE.WindowsStore.2.1.13\build\native\ANGLE.WindowsStore.targets')")
$importGroup.AppendChild($importGroupImport)
$xml.Project.AppendChild($importGroup)

$target = $xml.CreateElement("Target", $xml.Project.xmlns)
$target.SetAttribute("Name", "EnsureNuGetPackageBuildImports")
$target.SetAttribute("BeforeTargets", "PrepareForBuild")

$targetPropertyGroup = $xml.CreateElement("PropertyGroup", $xml.Project.xmlns)

$targetPropertyGroupErrorText = $xml.CreateElement("ErrorText", $xml.Project.xmlns)
$targetPropertyGroupErrorText.InnerXml = "This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}."
$targetPropertyGroup.AppendChild($targetPropertyGroupErrorText)

$targetError = $xml.CreateElement("Error", $xml.Project.xmlns)
$targetError.SetAttribute("Condition", "!Exists('..\packages\ANGLE.WindowsStore.2.1.13\build\native\ANGLE.WindowsStore.targets')")
$targetError.SetAttribute("Text", "$([System.String]::Format('$(ErrorText)', '..\packages\ANGLE.WindowsStore.2.1.13\build\native\ANGLE.WindowsStore.targets'))")

$target.AppendChild($targetPropertyGroup)
$target.AppendChild($targetError)

$xml.Project.AppendChild($target)

$xml.Save((Resolve-Path "${PROJECT_DIR}/${PROJECT_NAME}.vcxproj"))